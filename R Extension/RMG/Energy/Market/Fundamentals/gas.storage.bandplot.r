# Plot the historical bandwidth and mean of storage data
# The query is generated by LIM.Gas.storage.weekly(survey="Total", num.years=5), which is saved in Utils.r
# There are four possible 'survey':  "Consuming East", "Consuming West", "Producing" , "Total"


gas.storage.bandplot <- function(survey="Total", num.years=6, directory="C:\\BalanceSheets\\UpdatedFiles\\"){

  #'Utils.r' is not needed when this function is called from Fundamentals.xls
  # source("S:\\Risk\\UpdatedFiles\\Utils.r")
  query = LIM.Gas.storage.weekly(survey, num.years)[[1]]
  hist.storage = read.LIM(query)   # hist.storage contains (num.years +1)*2 cols, of which half describes the changes in storage values??
  dates =   hist.storage[,1] # of  "POSIXt class

  # Divide data into survey data and delta data
  survey.data = hist.storage[,2:(num.years+2)]
  delta.data = hist.storage[(num.years+3):ncol(hist.storage)]

  # Compute the mean, min, max of each week for all years???? (CHECK WITH YANNIS)

  survey.min = apply(survey.data, 1,min)
  survey.mean = apply(survey.data, 1,mean)
  survey.max = apply(survey.data, 1,max)
  survey.stats = cbind(survey.min, survey.mean,survey.max)
  
  delta.min = apply(delta.data, 1,min)
  delta.mean = apply(delta.data, 1,mean)
  delta.max = apply(delta.data, 1,max)
  delta.stats = cbind(delta.min, delta.mean, delta.max)
  
  # Save the plot as a jpeg saved in the given directory
  jpeg(filename = paste(directory,survey, ".jpg", sep=""), width = 640, height = 520)

  # Plot the bandwidth of survey data
  oldpar <- par(no.readonly=TRUE)

  par(mfrow=c(2,1))
  y.range <- range(survey.stats)
	plot(type="n",1:length(survey.min), ylim=y.range, axes=T, ylab="value", xlab=paste("Weeks", "\n", "Ending with week of ", format(dates[length(dates)], "%d%b%y"),sep=""))
  # Should we replace x by dates???
  # x<- c(dates, rev(dates))
  x <- c(1:length(survey.min), rev(1:length(survey.min)))
  y <- c(survey.max, rev(survey.min))
  polygon(x, y, density=-1, border="peachpuff", col="peachpuff")
  title(main=survey)
  lines(x=1:length(survey.min), y=survey.mean, col="darkorange", lwd=2, lty=2)
  legend(x="bottomleft", inset=0, legend=paste(num.years," yrs Hist. Avg.",sep=""), cex=.8, fill="peachpuff", bty="n",
  col="darkorange", text.col="darkorange",lty=2, lwd=2)
  
  
  # Injection Projection Not Completed
  # Which weeks need to be projected
  # week.proj = which(format(dates, "%Y")==CHANGE"2005")
  # project.val = rep(NA, length(week.proj))
  
  # "Exact" time period for withdr.
  # withdr.period <- c(format(as.Date("2006-11-15"), "%d%b"), format(as.Date("2006-12-31"), "%d%b"))
 
  # For each projection wekk, determine if it falls in inj. or withdr period
  # for(k in week.proj) {
  # if (format(dates[k],"%d%b") >= withdr.period[1] & format(dates[k],"%d%b") <= withdr.period[2]){
  
     
  # Plot the bandwidth of Inj/ Withdr
  y.range <- range(delta.stats)
	plot(type="n",1:length(delta.min), ylim=y.range, axes=T, ylab="value", xlab=paste("Weeks", "\n", "Ending with week of ", format(dates[length(dates)], "%d%b%y"),sep=""))
  # Should we replace x by dates???
  x <- c(1:length(delta.min), rev(1:length(delta.min)))
  y <- c(delta.max, rev(delta.min))
  polygon(x, y, density=-1, border="lightgrey", col="lightgrey")
  title(main=paste("Inj/Withdr of ", survey))
  lines(x=1:length(delta.min), y=delta.mean, col="darkcyan" , lwd=2, lty=2)
  abline(h=0, col=1, lty=3)
  legend(x="bottomleft", inset=0, legend=paste(num.years," yrs Hist. Avg.",sep=""), cex=.8, fill="lightgrey", bty="n",
  col="darkcyan", text.col="darkcyan",lty=2, lwd=2)
  par(oldpar)
  dev.off()

  # Do we need to return the data or just plot????
  # the.frame = hist.storage[,-1]
  # rownames(the.frame) <- dates
  # return(the.frame)
}


