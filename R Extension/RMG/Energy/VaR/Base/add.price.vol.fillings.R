# Add the price and vol data generated by buddy methodology for missing
# CPSPROD data.  Do this on the fly for each run...  
# Also, create the "Changes" sheet for IVaR.
#
# ------> Right now, just set all the missing changes to ZERO!!!!   <--------
#
# Returns the IVaR as list with two elements Prices and Changes ready for
# calculation. 
#
# Last modified by Adrian Dragulescu on 30-Mar-2007

add.price.vol.fillings <- function(IVaR, options){
  cat("Fill missing price and vol data... ")
  IVaR.Changes  <- IVaR
  if (options$parallel$is.necessary){IVaR <- NULL; gc()} # no debugging on parallel mode
  indDates.IVaR <- grep("-",names(IVaR.Changes))

  aux <- as.matrix(IVaR.Changes[, indDates.IVaR])
  # calc price/vol differences
  aux <- aux[,(1+options$calc$holding.period.days):ncol(aux)] -
         aux[,1:(ncol(aux)-options$calc$holding.period.days)]  
  
  IVaR.Changes[,indDates.IVaR[-(1:options$calc$holding.period.days)]] <- aux
  IVaR.Changes <- IVaR.Changes[,-indDates.IVaR[1:options$calc$holding.period.days]]
  rm(aux)
  
  ind.isna <- is.na(IVaR.Changes)
  ind.isna[,"vol.type"]  <- FALSE         # exclude the vol.type column
  if (any(ind.isna)){
     cat("\nWarning:  Buddy replacement failed.  Replacing missing",
         "price and vol changes with zero. \n")
     IVaR.Changes[ind.isna] <- 0             
  }
  
  #increase vol 100 time
  ind.vol <- which(IVaR.Changes$vol.type!="NA")
  if (length(ind.vol)>0){
    indDates <- grep("-",names(IVaR.Changes))
    IVaR.Changes[ind.vol,indDates] <- IVaR.Changes[ind.vol, indDates]*100
  }
  IVaR <- list(Prices=IVaR, Changes=IVaR.Changes)
  cat("Done.\n")
  return(IVaR)   # return the IVaR as a two element list. 
}


######################################################################
##   IVaR.Prices <- IVaR.Changes <- IVaR
##   IVaR$ind.IVaR <- 1:nrow(IVaR)
##   fPPVV  <- NULL
##   if (length(filled.mktData$prices)>0){
##     fPPVV  <- cbind(filled.mktData$prices, vol.type=NA)}   # put the prices
##   if (length(filled.mktData$vols)>0){
##     fPPVV  <- rbind(fPPVV, filled.mktData$vols)}           # and the vols together
##   if (length(fPPVV)>0){                                    # do fillings if you need
##     fPPVV  <- cbind(fPPVV, ind.fPPVV=1:nrow(fPPVV))        # and create an index
##     aux    <- merge(IVaR[, c("curve.name", "contract.dt", "vol.type", "ind.IVaR")],
##                     fPPVV[, c("curve.name", "contract.dt", "vol.type", "ind.fPPVV")], all=F)
##     indDates.IVaR  <- grep("-",colnames(IVaR.Prices))
##     indDates.fPPVV <- grep("-",colnames(fPPVV))
##     if (nrow(aux)>0){                                      # do it only if you need corrections 
##       fPPVV[, indDates.fPPVV] <- as.matrix(fPPVV[, indDates.fPPVV])*mktData$fx[fPPVV$denominated,]
##       IVaR.Changes[aux$ind.IVaR, indDates.IVaR] <- fPPVV[aux$ind.fPPVV, indDates.fPPVV]
##     }
##   }
##   IVaR.Changes[, indDates.IVaR[-1]] <- IVaR.Changes[,indDates.IVaR[-length(indDates.IVaR)]] -
##                   IVaR.Changes[,indDates.IVaR[-1]]   # calculate the changes 
##   IVaR.Changes <- IVaR.Changes[,-indDates.IVaR[1]]
##   IVaR.Prices$comment   <- ""
##   if (length(fPPVV)>0){
##     IVaR.Prices$comment[aux$ind.IVaR] <- fPPVV$comment[aux$ind.fPPVV]}
##   IVaR <- list(Prices=IVaR.Prices, Changes=IVaR.Changes)

##   # Check if somehow we couldn't replace all the missing values ...
##   ind <- which(apply(is.na(IVaR$Changes[,indDates.IVaR]), 1, any))
##   if (length(ind)>0){
##     msg <- paste("Following curves have no buddies.\nAll positions will be ignored.\n",
##       paste(IVaR$Changes$curve.name[ind], sep="", collapse="\n"))
##     tkmessageBox(message=msg)
##     IVaR$Changes <- IVaR$Changes[-ind,]    # remove the positions.  Should do better!
##   }

